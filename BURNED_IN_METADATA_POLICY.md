# Burned-in Metadata Policy

## Overview

This document describes the policy and implementation for burned-in metadata in the crgodicom tool, which is designed for DICOM integration debugging and testing.

## Policy

### Purpose
Burned-in metadata serves **integration debugging purposes only**. It helps developers and testers verify that:
- DICOM files contain the correct patient and study information
- Pixel data is properly embedded in DICOM files
- Integration workflows are functioning correctly

### Implementation Rules

#### 1. DICOM Creation (✅ Implemented)
- **Burned-in metadata IS added** to pixel data during DICOM creation
- Metadata includes:
  - Patient name and ID
  - Study and series information
  - Instance numbers
  - Modality information
  - Generation timestamp
  - Tool identification ("Generated by crgodicom flatmapit.com")
- Metadata is rendered as **bright white text on dark background** in the top-left corner
- This ensures the metadata is visible in DICOM viewers for debugging

#### 2. Export Process (✅ Implemented)
- **Burned-in metadata is NOT added** to exported images (PNG, JPEG, PDF)
- Exported images are **clean extractions** from DICOM pixel data
- This ensures exported images represent the actual DICOM content without additional overlays

## Technical Implementation

### DICOM Creation Process
```go
// In internal/dicom/generator.go
func (i *ImageGenerator) GenerateImageWithMetadata(study *types.Study, series *types.Series, instanceNumber, totalInstances int, width, height, bitsPerPixel int) ([]byte, error) {
    // 1. Generate base pattern (CT, CR, MR, etc.)
    pixelData, err := i.GenerateImage(series.Modality, width, height, bitsPerPixel)
    
    // 2. Add burned-in metadata to pixel data
    if err := i.addBurnedInMetadata(pixelData, study, series, instanceNumber, totalInstances, width, height, bitsPerPixel); err != nil {
        return nil, fmt.Errorf("failed to add burned-in metadata: %w", err)
    }
    
    return pixelData, nil
}
```

### Export Process
```go
// In internal/export/exporter.go
func (e *Exporter) exportImageToPNG(study *types.Study, series *types.Series, img *types.Image, instanceNum, totalInstances int, outputPath string) error {
    // Convert pixel data to grayscale image
    // Note: Burned-in metadata is NOT added to exported images.
    // Exported images should be clean extractions from DICOM pixel data only.
    
    // Save as PNG (clean extraction)
    return png.Encode(file, grayImage)
}
```

## Metadata Content

The burned-in metadata includes the following information:

```
Patient: [Patient Name]
Patient ID: [Patient ID]
DOB: [Date of Birth]
Accession: [Accession Number]
Study UID: [Study Instance UID]
Series UID: [Series Instance UID]
Instance: [X of Y]
Modality: [Modality Code]
Study Date: [Study Date]
Generated by crgodicom flatmapit.com
```

## Visual Appearance

- **Location**: Top-left corner of the image
- **Background**: Dark rectangle (low pixel values)
- **Text**: Bright white text (high pixel values)
- **Font**: Simple bitmap font (7x13 pixels per character)
- **Positioning**: 10px from left edge, 20px from top edge

## Benefits for Integration Debugging

1. **Visual Verification**: Developers can immediately see if patient/study data is correct
2. **Pixel Data Integrity**: Confirms that pixel data is properly embedded in DICOM
3. **Workflow Testing**: Helps verify end-to-end DICOM processing workflows
4. **Tool Identification**: Clearly identifies images generated by this tool

## Testing and Validation

### Test Cases
- [ ] DICOM files contain burned-in metadata in pixel data
- [ ] Exported PNG files do NOT contain additional burned-in metadata
- [ ] Exported JPEG files do NOT contain additional burned-in metadata
- [ ] Exported PDF files do NOT contain additional burned-in metadata
- [ ] Metadata is visible in DICOM viewers
- [ ] Metadata content matches study/series information

### Validation Commands
```bash
# Generate test DICOM with burned-in metadata
./crgodicom create --modality CT --image-count 2 --series-count 1

# Export to verify clean extraction
./crgodicom export --study-id [STUDY_ID] --format png

# View in DICOM viewer to verify burned-in metadata
# Check exported PNG to verify no additional metadata
```

## Future Considerations

- **Configurable Metadata**: Consider making metadata content configurable
- **Font Improvements**: Implement better bitmap fonts for improved readability
- **Position Options**: Allow different positioning of metadata overlay
- **Disable Option**: Add option to disable burned-in metadata for production use

## Related Files

- `internal/dicom/generator.go` - DICOM creation with burned-in metadata
- `internal/export/exporter.go` - Clean export without additional metadata
- `pkg/types/dicom.go` - Data structures for study/series information
